<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œ ë¶„ì„ ë¦¬í¬íŠ¸ - ëª¨ë°”ì¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-2xl">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- í—¤ë” -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                <h1 class="text-2xl font-bold mb-2" id="report-title">3D ë°œ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                <p class="text-blue-100" id="report-subtitle">ì •ë°€ ì¸¡ì • ë° ë§ì¶¤í˜• ë¶„ì„ ê²°ê³¼</p>
            </div>

            <!-- ë¦¬í¬íŠ¸ ë‚´ìš© -->
            <div id="report-content" class="p-6">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="p-6 bg-gray-50 border-t">
                <button onclick="downloadPDF()"
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg mb-3 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    PDF ë‹¤ìš´ë¡œë“œ
                </button>

                <button onclick="shareReport()"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z">
                        </path>
                    </svg>
                    ë¦¬í¬íŠ¸ ê³µìœ 
                </button>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="text-center text-gray-500 text-sm mt-6">
            <p>RunSync by ì„œì§„ì´ë„¤</p>
            <p>ì •ë°€í•œ ë°œ ì¸¡ì • ë° ë¶„ì„ ì‹œìŠ¤í…œ</p>
        </div>
    </div>

    <script>
        let reportData = null;
        let isDualFoot = false;

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ì¶”ì¶œ ë° í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (encodedData) {
                try {
                    const jsonData = decodeURIComponent(escape(atob(encodedData)));
                    const compactData = JSON.parse(jsonData);
                    
                    // ì–‘ë°œ ë°ì´í„°ì¸ì§€ í™•ì¸
                    isDualFoot = compactData.type === 'dual';
                    
                    if (isDualFoot) {
                        reportData = rehydrateDualFootData(compactData);
                        displayDualFootReport(reportData);
                    } else {
                        reportData = rehydrateReportData(compactData);
                        displaySingleFootReport(reportData);
                    }
                } catch (error) {
                    console.error('ë°ì´í„° ë””ì½”ë”© ì˜¤ë¥˜:', error);
                    showError('ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            } else {
                showError('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        });

        /**
         * ì–‘ë°œ QR ë°ì´í„°ë¥¼ ì „ì²´ ë¦¬í¬íŠ¸ ë°ì´í„°ë¡œ ë³€í™˜
         */
        function rehydrateDualFootData(compactData) {
            const avgLen = compactData.m.l;
            const avgWid = compactData.m.w;
            const avgHei = compactData.m.h;

            // ê°œë³„ ë°œ ë°ì´í„° ì¶”ì¶œ
            const leftFoot = compactData.lf ? {
                length: compactData.lf.l,
                width: compactData.lf.w,
                height: compactData.lf.h,
                unit: compactData.m.u
            } : null;

            const rightFoot = compactData.rf ? {
                length: compactData.rf.l,
                width: compactData.rf.w,
                height: compactData.rf.h,
                unit: compactData.m.u
            } : null;

            // ë°œ ìœ í˜• ë””ì½”ë”©
            let footType = 'Normal Foot Type';
            if (compactData.t === 'L') footType = 'Long Foot Type';
            else if (compactData.t === 'W') footType = 'Wide Foot Type';

            let archType = 'Normal Arch';
            if (compactData.a === 'H') archType = 'High Arch';
            else if (compactData.a === 'F') archType = 'Low Arch / Flat Foot';

            const descriptions = {
                'Long Foot Type': 'Elongated foot shape with longer toes and narrow profile',
                'Wide Foot Type': 'Broader foot shape with wider forefoot area',
                'Normal Foot Type': 'Well-balanced foot proportions with standard dimensions',
            };

            return {
                fileName: compactData.f,
                analysisDate: compactData.d,
                isDualFoot: true,
                averageMeasurements: {
                    length: avgLen.toFixed(1),
                    width: avgWid.toFixed(1),
                    height: avgHei.toFixed(1),
                    unit: compactData.m.u
                },
                leftFoot: leftFoot,
                rightFoot: rightFoot,
                ratios: {
                    lengthWidth: (avgLen && avgWid) ? (avgLen / avgWid).toFixed(2) : 'N/A',
                    heightLength: (avgHei && avgLen) ? ((avgHei / avgLen) * 100).toFixed(1) + '%' : 'N/A'
                },
                analysis: {
                    footType: footType,
                    archType: archType,
                    description: descriptions[footType] || 'Analysis based on QR data.'
                },
                comparison: leftFoot && rightFoot ? {
                    lengthDiff: Math.abs(leftFoot.length - rightFoot.length).toFixed(1),
                    widthDiff: Math.abs(leftFoot.width - rightFoot.width).toFixed(1),
                    heightDiff: Math.abs(leftFoot.height - rightFoot.height).toFixed(1),
                    symmetryScore: calculateSymmetryScore(leftFoot, rightFoot)
                } : null
            };
        }

        /**
         * ëŒ€ì¹­ì„± ì ìˆ˜ ê³„ì‚°
         */
        function calculateSymmetryScore(leftFoot, rightFoot) {
            const lengthDiff = Math.abs(leftFoot.length - rightFoot.length);
            const widthDiff = Math.abs(leftFoot.width - rightFoot.width);
            const heightDiff = Math.abs(leftFoot.height - rightFoot.height);

            const maxLength = Math.max(leftFoot.length, rightFoot.length);
            const maxWidth = Math.max(leftFoot.width, rightFoot.width);
            const maxHeight = Math.max(leftFoot.height, rightFoot.height);
            
            const lengthSymmetry = (1 - lengthDiff / maxLength) * 100;
            const widthSymmetry = (1 - widthDiff / maxWidth) * 100;
            const heightSymmetry = (1 - heightDiff / maxHeight) * 100;
            
            return Math.round((lengthSymmetry + widthSymmetry + heightSymmetry) / 3);
        }

        /**
         * ì–‘ë°œ ë¦¬í¬íŠ¸ í‘œì‹œ
         */
        function displayDualFootReport(data) {
            // í—¤ë” ì—…ë°ì´íŠ¸
            document.getElementById('report-title').textContent = '3D ì–‘ë°œ ë¶„ì„ ë¦¬í¬íŠ¸';
            document.getElementById('report-subtitle').textContent = 'ì–‘ë°œ ì •ë°€ ì¸¡ì • ë° ëŒ€ì¹­ì„± ë¶„ì„ ê²°ê³¼';

            const content = document.getElementById('report-content');
            const analysisDate = new Date(data.analysisDate);

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- íŒŒì¼ ì •ë³´ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ íŒŒì¼ ì •ë³´</h3>
                        <div class="grid grid-cols-1 gap-2 text-sm">
                            <div>
                                <span class="text-gray-600">íŒŒì¼ëª…:</span>
                                <p class="font-medium">${data.fileName}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">ë¶„ì„ì¼:</span>
                                <p class="font-medium">${analysisDate.toLocaleDateString('ko-KR')}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">ë¶„ì„ ìœ í˜•:</span>
                                <p class="font-medium text-blue-600">ì–‘ë°œ ì¢…í•© ë¶„ì„</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- í‰ê·  ì¸¡ì • ë°ì´í„° -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ í‰ê·  ì¸¡ì • ë°ì´í„°</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-blue-800 font-medium">í‰ê·  ë°œ ê¸¸ì´</span>
                                    <span class="text-blue-900 font-bold">${data.averageMeasurements.length} ${data.averageMeasurements.unit}</span>
                                </div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-green-800 font-medium">í‰ê·  ë°œ ë„ˆë¹„</span>
                                    <span class="text-green-900 font-bold">${data.averageMeasurements.width} ${data.averageMeasurements.unit}</span>
                                </div>
                            </div>
                            <div class="bg-purple-50 p-3 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="text-purple-800 font-medium">í‰ê·  ë°œ ë†’ì´</span>
                                    <span class="text-purple-900 font-bold">${data.averageMeasurements.height} ${data.averageMeasurements.unit}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${data.leftFoot && data.rightFoot ? `
                    <!-- ê°œë³„ ë°œ ì¸¡ì • ë°ì´í„° -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ‘¥ ê°œë³„ ë°œ ì¸¡ì • ë°ì´í„°</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- ì™¼ë°œ -->
                            <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                                <h4 class="font-semibold text-blue-800 mb-2">ğŸ‘ˆ ì™¼ë°œ</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>ê¸¸ì´:</span>
                                        <span class="font-mono">${data.leftFoot.length.toFixed(1)} ${data.leftFoot.unit}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ë„ˆë¹„:</span>
                                        <span class="font-mono">${data.leftFoot.width.toFixed(1)} ${data.leftFoot.unit}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ë†’ì´:</span>
                                        <span class="font-mono">${data.leftFoot.height.toFixed(1)} ${data.leftFoot.unit}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ì˜¤ë¥¸ë°œ -->
                            <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                                <h4 class="font-semibold text-green-800 mb-2">ğŸ‘‰ ì˜¤ë¥¸ë°œ</h4>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>ê¸¸ì´:</span>
                                        <span class="font-mono">${data.rightFoot.length.toFixed(1)} ${data.rightFoot.unit}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ë„ˆë¹„:</span>
                                        <span class="font-mono">${data.rightFoot.width.toFixed(1)} ${data.rightFoot.unit}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>ë†’ì´:</span>
                                        <span class="font-mono">${data.rightFoot.height.toFixed(1)} ${data.rightFoot.unit}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ëŒ€ì¹­ì„± ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">âš–ï¸ ëŒ€ì¹­ì„± ë¶„ì„</h3>
                        <div class="bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg">
                            <div class="text-center mb-4">
                                <div class="text-3xl font-bold ${data.comparison.symmetryScore >= 90 ? 'text-green-600' : data.comparison.symmetryScore >= 80 ? 'text-yellow-600' : 'text-red-600'}">${data.comparison.symmetryScore}%</div>
                                <div class="text-sm text-gray-600">ëŒ€ì¹­ì„± ì ìˆ˜</div>
                            </div>
                            <div class="grid grid-cols-1 gap-2 text-sm">
                                <div class="flex justify-between">
                                    <span>ê¸¸ì´ ì°¨ì´:</span>
                                    <span class="font-mono">${data.comparison.lengthDiff} mm</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ë„ˆë¹„ ì°¨ì´:</span>
                                    <span class="font-mono">${data.comparison.widthDiff} mm</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>ë†’ì´ ì°¨ì´:</span>
                                    <span class="font-mono">${data.comparison.heightDiff} mm</span>
                                </div>
                            </div>
                            <div class="mt-3 p-3 bg-white rounded text-center">
                                <p class="text-sm ${data.comparison.symmetryScore >= 90 ? 'text-green-700' : data.comparison.symmetryScore >= 80 ? 'text-yellow-700' : 'text-red-700'}">
                                    ${getDualFootSymmetryAssessment(data.comparison.symmetryScore)}
                                </p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- ë¹„ìœ¨ ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“Š ë¹„ìœ¨ ë¶„ì„</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600">${data.ratios.lengthWidth}</div>
                                <div class="text-sm text-gray-600">ê¸¸ì´/ë„ˆë¹„ ë¹„ìœ¨</div>
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center">
                                <div class="text-2xl font-bold text-cyan-600">${data.ratios.heightLength}</div>
                                <div class="text-sm text-gray-600">ë†’ì´/ê¸¸ì´ ë¹„ìœ¨</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ë°œ ìœ í˜• ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ‘£ ë°œ ìœ í˜• ë¶„ì„</h3>
                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-semibold text-blue-800">ë°œ í˜•íƒœ</span>
                                    <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">${getKoreanFootType(data.analysis.footType)}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="font-semibold text-purple-800">ì•„ì¹˜ ìœ í˜•</span>
                                    <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm">${getKoreanArchType(data.analysis.archType)}</span>
                                </div>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">${getKoreanDescription(data.analysis.description)}</p>
                        </div>
                    </div>
                    
                    <!-- ë§ì¶¤í˜• ì¶”ì²œ -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ’¡ ë§ì¶¤í˜• ì¶”ì²œ</h3>
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg">
                            <div class="space-y-2">
                                ${getDualFootRecommendations(data).map(rec => `<div class="flex items-start"><span class="text-green-600 mr-2">â€¢</span><span class="text-sm text-green-800">${rec}</span></div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * ë‹¨ì¼ ë°œ QRì½”ë“œë¡œ ë°›ì€ ì••ì¶• ë°ì´í„°ë¥¼ ì „ì²´ ë¦¬í¬íŠ¸ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
         */
        function rehydrateReportData(compactData) {
            const len = compactData.m.l;
            const wid = compactData.m.w;
            const hei = compactData.m.h;

            let footType = 'Normal Foot Type';
            if (compactData.t === 'L') footType = 'Long Foot Type';
            else if (compactData.t === 'W') footType = 'Wide Foot Type';

            let archType = 'Normal Arch';
            if (compactData.a === 'H') archType = 'High Arch';
            else if (compactData.a === 'F') archType = 'Low Arch / Flat Foot';

            const descriptions = {
                'Long Foot Type': 'Elongated foot shape with longer toes and narrow profile',
                'Wide Foot Type': 'Broader foot shape with wider forefoot area',
                'Normal Foot Type': 'Well-balanced foot proportions with standard dimensions',
            };

            return {
                fileName: compactData.f,
                analysisDate: compactData.d,
                isDualFoot: false,
                measurements: {
                    length: len.toFixed(1),
                    width: wid.toFixed(1),
                    height: hei.toFixed(1),
                    unit: compactData.m.u,
                    confidence: 'N/A (From QR)'
                },
                ratios: {
                    lengthWidth: (len && wid) ? (len / wid).toFixed(2) : 'N/A',
                    heightLength: (hei && len) ? ((hei / len) * 100).toFixed(1) + '%' : 'N/A'
                },
                analysis: {
                    footType: footType,
                    archType: archType,
                    description: descriptions[footType] || 'Analysis based on QR data.'
                },
            };
        }

        /**
         * ë‹¨ì¼ ë°œ ë¦¬í¬íŠ¸ ë‚´ìš©ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
         */
        function displaySingleFootReport(data) {
            const content = document.getElementById('report-content');
            const analysisDate = new Date(data.analysisDate);

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- íŒŒì¼ ì •ë³´ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ íŒŒì¼ ì •ë³´</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">íŒŒì¼ëª…:</span>
                                <p class="font-medium">${data.fileName}</p>
                            </div>
                            <div>
                                <span class="text-gray-600">ë¶„ì„ì¼:</span>
                                <p class="font-medium">${analysisDate.toLocaleDateString('ko-KR')}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¸¡ì • ë°ì´í„° -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ ì¸¡ì • ë°ì´í„°</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="bg-red-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-red-800 font-medium">ë°œ ê¸¸ì´</span><span class="text-red-900 font-bold">${data.measurements.length} ${data.measurements.unit}</span></div></div>
                            <div class="bg-yellow-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-yellow-800 font-medium">ë°œ ë„ˆë¹„</span><span class="text-yellow-900 font-bold">${data.measurements.width} ${data.measurements.unit}</span></div></div>
                            <div class="bg-purple-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-purple-800 font-medium">ë°œ ë†’ì´</span><span class="text-purple-900 font-bold">${data.measurements.height} ${data.measurements.unit}</span></div></div>
                            <div class="bg-blue-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-blue-800 font-medium">ì¸¡ì • ì‹ ë¢°ë„</span><span class="text-blue-900 font-bold">${data.measurements.confidence}</span></div></div>
                        </div>
                    </div>
                    
                    <!-- ë¹„ìœ¨ ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“Š ë¹„ìœ¨ ë¶„ì„</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${data.ratios.lengthWidth}</div><div class="text-sm text-gray-600">ê¸¸ì´/ë„ˆë¹„ ë¹„ìœ¨</div></div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-cyan-600">${data.ratios.heightLength}</div><div class="text-sm text-gray-600">ë†’ì´/ê¸¸ì´ ë¹„ìœ¨</div></div>
                        </div>
                    </div>
                    
                    <!-- ë°œ ìœ í˜• ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ‘£ ë°œ ìœ í˜• ë¶„ì„</h3>
                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-2"><span class="font-semibold text-blue-800">ë°œ í˜•íƒœ</span><span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">${getKoreanFootType(data.analysis.footType)}</span></div>
                                <div class="flex items-center justify-between"><span class="font-semibold text-purple-800">ì•„ì¹˜ ìœ í˜•</span><span class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm">${getKoreanArchType(data.analysis.archType)}</span></div>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">${getKoreanDescription(data.analysis.description)}</p>
                        </div>
                    </div>
                    
                    <!-- ì¶”ì²œ ì‚¬í•­ -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ’¡ ë§ì¶¤í˜• ì¶”ì²œ</h3>
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg"><div class="space-y-2">${getSingleFootRecommendations(data).map(rec => `<div class="flex items-start"><span class="text-green-600 mr-2">â€¢</span><span class="text-sm text-green-800">${rec}</span></div>`).join('')}</div></div>
                    </div>
                </div>
            `;
        }

        /**
         * ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         */
        function showError(message) {
            const content = document.getElementById('report-content');
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
                    <p class="text-red-600 font-medium">${message}</p>
                    <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                </div>
            `;
        }

        // --- ëŒ€ì¹­ì„± í‰ê°€ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€) ---
        function getDualFootSymmetryAssessment(score) {
            if (score >= 95) {
                return 'ì™„ë²½í•œ ëŒ€ì¹­ì„±ì„ ë³´ì…ë‹ˆë‹¤. ë§¤ìš° ê· í˜•ì¡íŒ ë°œ êµ¬ì¡°ì…ë‹ˆë‹¤.';
            } else if (score >= 90) {
                return 'ìš°ìˆ˜í•œ ëŒ€ì¹­ì„±ì„ ë³´ì…ë‹ˆë‹¤. ê· í˜•ì¡íŒ ë°œ êµ¬ì¡°ë¥¼ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤.';
            } else if (score >= 80) {
                return 'ì–‘í˜¸í•œ ëŒ€ì¹­ì„±ì„ ë³´ì…ë‹ˆë‹¤. ì•½ê°„ì˜ ì°¨ì´ëŠ” ìˆì§€ë§Œ ì •ìƒ ë²”ìœ„ì…ë‹ˆë‹¤.';
            } else if (score >= 70) {
                return 'ë³´í†µ ìˆ˜ì¤€ì˜ ëŒ€ì¹­ì„±ì…ë‹ˆë‹¤. ì•½ê°„ì˜ ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.';
            } else if (score >= 60) {
                return 'ëŒ€ì¹­ì„±ì´ ë‹¤ì†Œ ë¶€ì¡±í•©ë‹ˆë‹¤. ì •ê¸°ì ì¸ ê´€ì°°ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            } else {
                return 'ìƒë‹¹í•œ ë¹„ëŒ€ì¹­ì„±ì´ ê´€ì°°ë©ë‹ˆë‹¤. ì „ë¬¸ì˜ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
            }
        }

        // --- ì–‘ë°œ ì¶”ì²œì‚¬í•­ ìƒì„± í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€) ---
        function getDualFootRecommendations(data) {
            const recommendations = [];
            
            // ëŒ€ì¹­ì„± ê¸°ë°˜ ì¶”ì²œ
            if (data.comparison) {
                const score = data.comparison.symmetryScore;
                if (score >= 90) {
                    recommendations.push('ìš°ìˆ˜í•œ ëŒ€ì¹­ì„±ìœ¼ë¡œ ì¼ë°˜ì ì¸ ì‹ ë°œ ì°©ìš©ì´ ì í•©í•©ë‹ˆë‹¤');
                } else if (score >= 80) {
                    recommendations.push('ì–‘í˜¸í•œ ëŒ€ì¹­ì„±ì´ë‚˜ ì •ê¸°ì ì¸ ë°œ ê±´ê°• ì²´í¬ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤');
                } else {
                    recommendations.push('ëŒ€ì¹­ì„± ê°œì„ ì„ ìœ„í•œ ë°œ ìš´ë™ ë° ì „ë¬¸ì˜ ìƒë‹´ì„ ê¶Œì¥í•©ë‹ˆë‹¤');
                }

                // ê°œë³„ ì°¨ì´ ê¸°ë°˜ ì¶”ì²œ
                const lengthDiff = parseFloat(data.comparison.lengthDiff);
                const widthDiff = parseFloat(data.comparison.widthDiff);
                const heightDiff = parseFloat(data.comparison.heightDiff);

                if (lengthDiff > 5) {
                    recommendations.push('ë°œ ê¸¸ì´ ì°¨ì´ë¡œ ì¸í•´ ë§ì¶¤ ê¹”ì°½ ì‚¬ìš©ì„ ê³ ë ¤í•´ë³´ì„¸ìš”');
                }
                if (widthDiff > 3) {
                    recommendations.push('ë°œ ë„ˆë¹„ ì°¨ì´ë¡œ ì¸í•´ ë„‰ë„‰í•œ í­ì˜ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
                }
                if (heightDiff > 4) {
                    recommendations.push('ë°œ ë†’ì´ ì°¨ì´ë¡œ ì¸í•´ ì•„ì¹˜ ì„œí¬íŠ¸ê°€ ìˆëŠ” ê¹”ì°½ì„ ì¶”ì²œí•©ë‹ˆë‹¤');
                }
            }

            // í‰ê·  ë°œ í˜•íƒœ ê¸°ë°˜ ì¶”ì²œ
            const lwRatio = parseFloat(data.ratios.lengthWidth);
            const hlRatioStr = data.ratios.heightLength || '0%';
            const hlRatio = parseFloat(hlRatioStr.replace('%', ''));

            if (lwRatio > 2.6) {
                recommendations.push('ê¸´ ë°œí˜•ìœ¼ë¡œ ì•ì½”ê°€ ì—¬ìœ ë¡œìš´ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
                recommendations.push('ì¼ë°˜ ë˜ëŠ” ì™€ì´ë“œ í­ì˜ ì‹ ë°œì„ ê¶Œì¥í•©ë‹ˆë‹¤');
            } else if (lwRatio < 2.2) {
                recommendations.push('ë„“ì€ ë°œí˜•ìœ¼ë¡œ ì™€ì´ë“œ í”¼íŒ… ì‹ ë°œì´ í•„ìˆ˜ì…ë‹ˆë‹¤');
                recommendations.push('ì¢ê±°ë‚˜ ë¾°ì¡±í•œ ì‹ ë°œ ë””ìì¸ì€ í”¼í•˜ì„¸ìš”');
            } else {
                recommendations.push('í‘œì¤€ ë¹„ìœ¨ì˜ ë°œë¡œ ì¼ë°˜ì ì¸ ì‹ ë°œì´ ì í•©í•©ë‹ˆë‹¤');
                recommendations.push('ëŒ€ë¶€ë¶„ì˜ í‘œì¤€ ì‹ ë°œ ë””ìì¸ì´ ì˜ ë§ì„ ê²ƒì…ë‹ˆë‹¤');
            }

            if (hlRatio > 25) {
                recommendations.push('ë†’ì€ ì•„ì¹˜ë¡œ ê°•í•œ ì•„ì¹˜ ì„œí¬íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤');
                recommendations.push('ì¶©ê²© í¡ìˆ˜ê°€ ìš°ìˆ˜í•œ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
            } else if (hlRatio < 18) {
                recommendations.push('ë‚®ì€ ì•„ì¹˜ë¡œ ëª¨ì…˜ ì»¨íŠ¸ë¡¤ ê¸°ëŠ¥ì´ ìˆëŠ” ì‹ ë°œì„ ê¶Œì¥í•©ë‹ˆë‹¤');
                recommendations.push('ë‹¨ë‹¨í•œ ë’¤ê¿ˆì¹˜ ì§€ì§€ëŒ€ê°€ ìˆëŠ” ì‹ ë°œì´ ì¢‹ìŠµë‹ˆë‹¤');
            } else {
                recommendations.push('ì •ìƒ ì•„ì¹˜ë¡œ ì¼ë°˜ ìš´ë™í™”ë‚˜ ì›Œí‚¹í™”ê°€ ì í•©í•©ë‹ˆë‹¤');
                recommendations.push('ì ë‹¹í•œ ì¿ ì…”ë‹ê³¼ ì•ˆì •ì„±ì„ ì œê³µí•˜ëŠ” ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
            }

            // ì–‘ë°œ ì „ìš© ì¶”ì²œ
            recommendations.push('ì–‘ë°œì˜ ê±´ê°•ì„ ìœ„í•´ ì •ê¸°ì ì¸ ë°œ ìš´ë™ì„ ì‹¤ì‹œí•˜ì„¸ìš”');
            recommendations.push('ì–‘ë°œ ìƒíƒœë¥¼ ì •ê¸°ì ìœ¼ë¡œ í™•ì¸í•˜ê³  ë³€í™”ë¥¼ ê´€ì°°í•˜ì„¸ìš”');

            return recommendations;
        }

        // --- í•œê¸€ ë²ˆì—­ ë° ì¶”ì²œ ìƒì„± í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ìœ ì§€) ---
        function getKoreanFootType(footType) {
            switch (footType) {
                case 'Long Foot Type': return 'ê¸´ ë°œí˜•';
                case 'Wide Foot Type': return 'ë„“ì€ ë°œí˜•';
                case 'Normal Foot Type': return 'í‘œì¤€ ë°œí˜•';
                default: return 'ë¶„ì„ ì¤‘';
            }
        }

        function getKoreanArchType(archType) {
            switch (archType) {
                case 'High Arch': return 'ë†’ì€ ì•„ì¹˜';
                case 'Low Arch / Flat Foot': return 'ë‚®ì€ ì•„ì¹˜';
                case 'Normal Arch': return 'ì •ìƒ ì•„ì¹˜';
                default: return 'ë¶„ì„ ì¤‘';
            }
        }

        function getKoreanDescription(description) {
            const translations = {
                'Elongated foot shape with longer toes and narrow profile': 'ë°œê°€ë½ì´ ê¸¸ê³  ì „ì²´ì ìœ¼ë¡œ ì„¸ë ¨ëœ í˜•íƒœì…ë‹ˆë‹¤.',
                'Broader foot shape with wider forefoot area': 'ë°œë³¼ì´ ë„“ê³  ì•ˆì •ì ì¸ í˜•íƒœì…ë‹ˆë‹¤.',
                'Well-balanced foot proportions with standard dimensions': 'ê· í˜•ì¡íŒ ë¹„ë¡€ë¥¼ ê°€ì§„ í‘œì¤€ì ì¸ ë°œ í˜•íƒœì…ë‹ˆë‹¤.',
                'Insufficient data for comprehensive analysis': 'í¬ê´„ì ì¸ ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'
            };
            return translations[description] || description;
        }

        function getSingleFootRecommendations(data) {
            const lwRatio = parseFloat(data.ratios.lengthWidth);
            const hlRatioString = data.ratios.heightLength || '0%';
            const hlRatio = parseFloat(hlRatioString.replace('%', ''));
            const recommendations = [];

            if (lwRatio > 2.6) {
                recommendations.push('ì•ì½”ê°€ ì—¬ìœ ë¡œìš´ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
                recommendations.push('ì¢ì€ ì‹ ë°œë³´ë‹¤ëŠ” ì¼ë°˜ í­ ì´ìƒì„ ê¶Œì¥í•©ë‹ˆë‹¤');
            } else if (lwRatio < 2.2) {
                recommendations.push('ì™€ì´ë“œ í”¼íŒ… ì‹ ë°œì„ ê³ ë ¤í•´ë³´ì„¸ìš”');
                recommendations.push('ë°œë³¼ ë¶€ìœ„ ì••ë°•ì´ ì ì€ ë””ìì¸ì´ ì¢‹ìŠµë‹ˆë‹¤');
            } else {
                recommendations.push('ì¼ë°˜ì ì¸ í­ì˜ ì‹ ë°œì´ ì í•©í•©ë‹ˆë‹¤');
                recommendations.push('ëŒ€ë¶€ë¶„ì˜ í‘œì¤€ ì‹ ë°œ ë””ìì¸ì´ ì˜ ë§ì„ ê²ƒì…ë‹ˆë‹¤');
            }

            if (hlRatio > 25) {
                recommendations.push('ì•„ì¹˜ ì„œí¬íŠ¸ê°€ ê°•í•œ ê¹”ì°½ì„ ì‚¬ìš©í•˜ì„¸ìš”');
                recommendations.push('ì¶©ê²© í¡ìˆ˜ ê¸°ëŠ¥ì´ ë›°ì–´ë‚œ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
            } else if (hlRatio < 18) {
                recommendations.push('ëª¨ì…˜ ì»¨íŠ¸ë¡¤ ê¸°ëŠ¥ì´ ìˆëŠ” ì‹ ë°œì„ ê¶Œì¥í•©ë‹ˆë‹¤');
                recommendations.push('ë‹¨ë‹¨í•œ ë’¤ê¿ˆì¹˜ ì§€ì§€ëŒ€ê°€ ìˆëŠ” ì‹ ë°œì´ ì¢‹ìŠµë‹ˆë‹¤');
            } else {
                recommendations.push('ì¼ë°˜ì ì¸ ëŸ¬ë‹í™”ë‚˜ ì›Œí‚¹í™”ê°€ ì í•©í•©ë‹ˆë‹¤');
                recommendations.push('ì ë‹¹í•œ ì¿ ì…”ë‹ê³¼ ì•ˆì •ì„±ì„ ì œê³µí•˜ëŠ” ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
            }

            return recommendations;
        }

        // --- PDF ë‹¤ìš´ë¡œë“œ ë° ê³µìœ  ê¸°ëŠ¥ ---
        function downloadPDF() {
            if (!reportData) {
                alert('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                if (isDualFoot) {
                    // ì–‘ë°œ PDF ìƒì„±
                    doc.setFontSize(20);
                    doc.text('Dual Foot 3D Analysis Report', 20, 30);
                    
                    doc.setFontSize(12);
                    doc.text(`File: ${reportData.fileName}`, 20, 50);
                    doc.text(`Analysis Date: ${new Date(reportData.analysisDate).toLocaleDateString()}`, 20, 60);
                    doc.text('Report Type: Dual Foot Analysis', 20, 70);

                    // í‰ê·  ì¸¡ì • ë°ì´í„°
                    doc.setFontSize(16);
                    doc.text('Average Measurements', 20, 90);
                    doc.setFontSize(12);
                    doc.text(`Length: ${reportData.averageMeasurements.length} ${reportData.averageMeasurements.unit}`, 20, 105);
                    doc.text(`Width: ${reportData.averageMeasurements.width} ${reportData.averageMeasurements.unit}`, 20, 115);
                    doc.text(`Height: ${reportData.averageMeasurements.height} ${reportData.averageMeasurements.unit}`, 20, 125);

                    if (reportData.leftFoot && reportData.rightFoot) {
                        // ê°œë³„ ë°œ ë°ì´í„°
                        doc.setFontSize(16);
                        doc.text('Individual Foot Data', 20, 145);
                        doc.setFontSize(12);
                        doc.text('Left Foot:', 20, 160);
                        doc.text(`  Length: ${reportData.leftFoot.length.toFixed(1)} ${reportData.leftFoot.unit}`, 25, 170);
                        doc.text(`  Width: ${reportData.leftFoot.width.toFixed(1)} ${reportData.leftFoot.unit}`, 25, 180);
                        doc.text(`  Height: ${reportData.leftFoot.height.toFixed(1)} ${reportData.leftFoot.unit}`, 25, 190);

                        doc.text('Right Foot:', 20, 205);
                        doc.text(`  Length: ${reportData.rightFoot.length.toFixed(1)} ${reportData.rightFoot.unit}`, 25, 215);
                        doc.text(`  Width: ${reportData.rightFoot.width.toFixed(1)} ${reportData.rightFoot.unit}`, 25, 225);
                        doc.text(`  Height: ${reportData.rightFoot.height.toFixed(1)} ${reportData.rightFoot.unit}`, 25, 235);

                        // ëŒ€ì¹­ì„± ë¶„ì„
                        doc.setFontSize(16);
                        doc.text('Symmetry Analysis', 20, 255);
                        doc.setFontSize(12);
                        doc.text(`Symmetry Score: ${reportData.comparison.symmetryScore}%`, 20, 270);
                    }

                    const fileName = `dual_foot_analysis_${reportData.fileName.replace('.ply', '')}_mobile.pdf`;
                    doc.save(fileName);
                } else {
                    // ë‹¨ì¼ ë°œ PDF ìƒì„± (ê¸°ì¡´ ë¡œì§)
                    doc.setFontSize(20);
                    doc.text('3D Foot Analysis Report', 20, 30);
                    doc.setFontSize(12);
                    doc.text(`File: ${reportData.fileName}`, 20, 50);
                    doc.text(`Analysis Date: ${new Date(reportData.analysisDate).toLocaleDateString()}`, 20, 60);
                    doc.setFontSize(16);
                    doc.text('Measurements', 20, 80);
                    doc.setFontSize(12);
                    doc.text(`Length: ${reportData.measurements.length} ${reportData.measurements.unit}`, 20, 95);
                    doc.text(`Width: ${reportData.measurements.width} ${reportData.measurements.unit}`, 20, 105);
                    doc.text(`Height: ${reportData.measurements.height} ${reportData.measurements.unit}`, 20, 115);
                    doc.setFontSize(16);
                    doc.text('Ratios', 20, 135);
                    doc.setFontSize(12);
                    doc.text(`L/W Ratio: ${reportData.ratios.lengthWidth}`, 20, 150);
                    doc.text(`H/L Ratio: ${reportData.ratios.heightLength}`, 20, 160);
                    doc.setFontSize(16);
                    doc.text('Foot Analysis', 20, 180);
                    doc.setFontSize(12);
                    doc.text(`Foot Type: ${reportData.analysis.footType}`, 20, 195);
                    doc.text(`Arch Type: ${reportData.analysis.archType}`, 20, 205);

                    const fileName = `foot_analysis_${reportData.fileName.replace('.ply', '')}_mobile.pdf`;
                    doc.save(fileName);
                }

            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function shareReport() {
            if (navigator.share) {
                const title = isDualFoot ? '3D ì–‘ë°œ ë¶„ì„ ë¦¬í¬íŠ¸' : '3D ë°œ ë¶„ì„ ë¦¬í¬íŠ¸';
                const text = isDualFoot ? 
                    `${reportData?.fileName || 'ì–‘ë°œ ë¶„ì„'} ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”. ëŒ€ì¹­ì„± ì ìˆ˜: ${reportData?.comparison?.symmetryScore || 'N/A'}%` :
                    `${reportData?.fileName || 'ë°œ ë¶„ì„'} ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.`;
                
                navigator.share({
                    title: title,
                    text: text,
                    url: window.location.href
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('ë¦¬í¬íŠ¸ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }).catch(() => {
                    alert('ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                });
            }
        }
    </script>
</body>

</html>