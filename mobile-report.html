<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œ ë¶„ì„ ë¦¬í¬íŠ¸ - ëª¨ë°”ì¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-4 max-w-2xl">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- í—¤ë” -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6">
                <h1 class="text-2xl font-bold mb-2">3D ë°œ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                <p class="text-blue-100">ì •ë°€ ì¸¡ì • ë° ë§ì¶¤í˜• ë¶„ì„ ê²°ê³¼</p>
            </div>

            <!-- ë¦¬í¬íŠ¸ ë‚´ìš© -->
            <div id="report-content" class="p-6">
                <div class="text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">ë¦¬í¬íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ -->
            <div class="p-6 bg-gray-50 border-t">
                <button onclick="downloadPDF()"
                    class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg mb-3 flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    PDF ë‹¤ìš´ë¡œë“œ
                </button>

                <button onclick="shareReport()"
                    class="w-full bg-green-600 text-white py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z">
                        </path>
                    </svg>
                    ë¦¬í¬íŠ¸ ê³µìœ 
                </button>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="text-center text-gray-500 text-sm mt-6">
            <p>RunSync by ì„œì§„ì´ë„¤</p>
            <p>ì •ë°€í•œ ë°œ ì¸¡ì • ë° ë¶„ì„ ì‹œìŠ¤í…œ</p>
        </div>
    </div>

    <script>
        let reportData = null;

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ ë°ì´í„° ì¶”ì¶œ ë° í‘œì‹œ
        document.addEventListener('DOMContentLoaded', function () {
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');

            if (encodedData) {
                try {
                    const jsonData = decodeURIComponent(escape(atob(encodedData)));
                    const compactData = JSON.parse(jsonData);
                    reportData = rehydrateReportData(compactData); // ì••ì¶• ë°ì´í„° -> ì „ì²´ ë°ì´í„°ë¡œ ë³€í™˜
                    displayReport(reportData); // ë³€í™˜ëœ ë°ì´í„°ë¡œ í™”ë©´ í‘œì‹œ
                } catch (error) {
                    console.error('ë°ì´í„° ë””ì½”ë”© ì˜¤ë¥˜:', error);
                    showError('ë¦¬í¬íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); // showError í•¨ìˆ˜ í˜¸ì¶œ
                }
            } else {
                showError('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); // showError í•¨ìˆ˜ í˜¸ì¶œ
            }
        });

        /**
         * QRì½”ë“œë¡œ ë°›ì€ ì••ì¶• ë°ì´í„°ë¥¼ ì „ì²´ ë¦¬í¬íŠ¸ ë°ì´í„° í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
         */
        function rehydrateReportData(compactData) {
            const len = compactData.m.l;
            const wid = compactData.m.w;
            const hei = compactData.m.h;

            let footType = 'Normal Foot Type';
            if (compactData.t === 'L') footType = 'Long Foot Type';
            else if (compactData.t === 'W') footType = 'Wide Foot Type';

            let archType = 'Normal Arch';
            if (compactData.a === 'H') archType = 'High Arch';
            else if (compactData.a === 'F') archType = 'Low Arch / Flat Foot';

            const descriptions = {
                'Long Foot Type': 'Elongated foot shape with longer toes and narrow profile',
                'Wide Foot Type': 'Broader foot shape with wider forefoot area',
                'Normal Foot Type': 'Well-balanced foot proportions with standard dimensions',
            };

            return {
                fileName: compactData.f,
                analysisDate: compactData.d,
                measurements: {
                    length: len.toFixed(1),
                    width: wid.toFixed(1),
                    height: hei.toFixed(1),
                    unit: compactData.m.u,
                    confidence: 'N/A (From QR)'
                },
                ratios: {
                    lengthWidth: (len && wid) ? (len / wid).toFixed(2) : 'N/A',
                    heightLength: (hei && len) ? ((hei / len) * 100).toFixed(1) + '%' : 'N/A'
                },
                analysis: {
                    footType: footType,
                    archType: archType,
                    description: descriptions[footType] || 'Analysis based on QR data.'
                },
            };
        }

        /**
         * ë¦¬í¬íŠ¸ ë‚´ìš©ì„ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
         */
        function displayReport(data) {
            const content = document.getElementById('report-content');
            const analysisDate = new Date(data.analysisDate);

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- ... (HTML í…œí”Œë¦¿ ë¶€ë¶„ì€ ì´ì „ ë‹µë³€ê³¼ ë™ì¼) ... -->
                    <!-- íŒŒì¼ ì •ë³´ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ íŒŒì¼ ì •ë³´</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <span class="text-gray-600">íŒŒì¼ëª…:</span>
                                <p class="font-medium">${data.fileName}</p>
                            </div>
                            <p></p>
                            <div>
                                <span class="text-gray-600">ë¶„ì„ì¼:</span>
                                <p class="font-medium">${analysisDate.toLocaleDateString('ko-KR')}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ì¸¡ì • ë°ì´í„° -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“ ì¸¡ì • ë°ì´í„°</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="bg-red-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-red-800 font-medium">ë°œ ê¸¸ì´</span><span class="text-red-900 font-bold">${data.measurements.length} ${data.measurements.unit}</span></div></div>
                            <div class="bg-yellow-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-yellow-800 font-medium">ë°œ ë„ˆë¹„</span><span class="text-yellow-900 font-bold">${data.measurements.width} ${data.measurements.unit}</span></div></div>
                            <div class="bg-purple-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-purple-800 font-medium">ë°œ ë†’ì´</span><span class="text-purple-900 font-bold">${data.measurements.height} ${data.measurements.unit}</span></div></div>
                            <div class="bg-blue-50 p-3 rounded-lg"><div class="flex justify-between items-center"><span class="text-blue-800 font-medium">ì¸¡ì • ì‹ ë¢°ë„</span><span class="text-blue-900 font-bold">${data.measurements.confidence}</span></div></div>
                        </div>
                    </div>
                    
                    <!-- ë¹„ìœ¨ ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ“Š ë¹„ìœ¨ ë¶„ì„</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gray-50 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-blue-600">${data.ratios.lengthWidth}</div><div class="text-sm text-gray-600">ê¸¸ì´/ë„ˆë¹„ ë¹„ìœ¨</div></div>
                            <div class="bg-gray-50 p-3 rounded-lg text-center"><div class="text-2xl font-bold text-cyan-600">${data.ratios.heightLength}</div><div class="text-sm text-gray-600">ë†’ì´/ê¸¸ì´ ë¹„ìœ¨</div></div>
                        </div>
                    </div>
                    
                    <!-- ë°œ ìœ í˜• ë¶„ì„ -->
                    <div class="border-b pb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ‘£ ë°œ ìœ í˜• ë¶„ì„</h3>
                        <div class="space-y-3">
                            <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
                                <div class="flex items-center justify-between mb-2"><span class="font-semibold text-blue-800">ë°œ í˜•íƒœ</span><span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm">${getKoreanFootType(data.analysis.footType)}</span></div>
                                <div class="flex items-center justify-between"><span class="font-semibold text-purple-800">ì•„ì¹˜ ìœ í˜•</span><span class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm">${getKoreanArchType(data.analysis.archType)}</span></div>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed">${getKoreanDescription(data.analysis.description)}</p>
                        </div>
                    </div>
                    
                    <!-- ì¶”ì²œ ì‚¬í•­ -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">ğŸ’¡ ë§ì¶¤í˜• ì¶”ì²œ</h3>
                        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-r-lg"><div class="space-y-2">${getKoreanRecommendations(data).map(rec => `<div class="flex items-start"><span class="text-green-600 mr-2">â€¢</span><span class="text-sm text-green-800">${rec}</span></div>`).join('')}</div></div>
                    </div>
                </div>
            `;
        }

        /**
         * ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜ (ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜)
         */
        function showError(message) {
            const content = document.getElementById('report-content');
            content.innerHTML = `
                <div class="text-center py-8">
                    <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
                    <p class="text-red-600 font-medium">${message}</p>
                    <button onclick="location.reload()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg">
                        ë‹¤ì‹œ ì‹œë„
                    </button>
                </div>
            `;
        }

        // --- í•œê¸€ ë²ˆì—­ ë° ì¶”ì²œ ìƒì„± í•¨ìˆ˜ë“¤ (ëˆ„ë½ë˜ì—ˆë˜ í•¨ìˆ˜ë“¤) ---
        function getKoreanFootType(footType) {
            switch (footType) {
                case 'Long Foot Type': return 'ê¸´ ë°œí˜•';
                case 'Wide Foot Type': return 'ë„“ì€ ë°œí˜•';
                case 'Normal Foot Type': return 'í‘œì¤€ ë°œí˜•';
                default: return 'ë¶„ì„ ì¤‘';
            }
        }

        function getKoreanArchType(archType) {
            switch (archType) {
                case 'High Arch': return 'ë†’ì€ ì•„ì¹˜';
                case 'Low Arch / Flat Foot': return 'ë‚®ì€ ì•„ì¹˜';
                case 'Normal Arch': return 'ì •ìƒ ì•„ì¹˜';
                default: return 'ë¶„ì„ ì¤‘';
            }
        }

        function getKoreanDescription(description) {
            const translations = {
                'Elongated foot shape with longer toes and narrow profile': 'ë°œê°€ë½ì´ ê¸¸ê³  ì „ì²´ì ìœ¼ë¡œ ì„¸ë ¨ëœ í˜•íƒœì…ë‹ˆë‹¤.',
                'Broader foot shape with wider forefoot area': 'ë°œë³¼ì´ ë„“ê³  ì•ˆì •ì ì¸ í˜•íƒœì…ë‹ˆë‹¤.',
                'Well-balanced foot proportions with standard dimensions': 'ê· í˜•ì¡íŒ ë¹„ë¡€ë¥¼ ê°€ì§„ í‘œì¤€ì ì¸ ë°œ í˜•íƒœì…ë‹ˆë‹¤.',
                'Insufficient data for comprehensive analysis': 'í¬ê´„ì ì¸ ë¶„ì„ì„ ìœ„í•œ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.'
            };
            return translations[description] || description;
        }

        function getKoreanRecommendations(data) {
            const lwRatio = parseFloat(data.ratios.lengthWidth);
            const hlRatioString = data.ratios.heightLength || '0%';
            const hlRatio = parseFloat(hlRatioString.replace('%', ''));
            const recommendations = [];

            if (lwRatio > 2.6) {
                recommendations.push('ì•ì½”ê°€ ì—¬ìœ ë¡œìš´ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
                recommendations.push('ì¢ì€ ì‹ ë°œë³´ë‹¤ëŠ” ì¼ë°˜ í­ ì´ìƒì„ ê¶Œì¥í•©ë‹ˆë‹¤');
            } else if (lwRatio < 2.2) {
                recommendations.push('ì™€ì´ë“œ í”¼íŒ… ì‹ ë°œì„ ê³ ë ¤í•´ë³´ì„¸ìš”');
                recommendations.push('ë°œë³¼ ë¶€ìœ„ ì••ë°•ì´ ì ì€ ë””ìì¸ì´ ì¢‹ìŠµë‹ˆë‹¤');
            } else {
                recommendations.push('ì¼ë°˜ì ì¸ í­ì˜ ì‹ ë°œì´ ì í•©í•©ë‹ˆë‹¤');
                recommendations.push('ëŒ€ë¶€ë¶„ì˜ í‘œì¤€ ì‹ ë°œ ë””ìì¸ì´ ì˜ ë§ì„ ê²ƒì…ë‹ˆë‹¤');
            }

            if (hlRatio > 25) {
                recommendations.push('ì•„ì¹˜ ì„œí¬íŠ¸ê°€ ê°•í•œ ê¹”ì°½ì„ ì‚¬ìš©í•˜ì„¸ìš”');
                recommendations.push('ì¶©ê²© í¡ìˆ˜ ê¸°ëŠ¥ì´ ë›°ì–´ë‚œ ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
            } else if (hlRatio < 18) {
                recommendations.push('ëª¨ì…˜ ì»¨íŠ¸ë¡¤ ê¸°ëŠ¥ì´ ìˆëŠ” ì‹ ë°œì„ ê¶Œì¥í•©ë‹ˆë‹¤');
                recommendations.push('ë‹¨ë‹¨í•œ ë’¤ê¿ˆì¹˜ ì§€ì§€ëŒ€ê°€ ìˆëŠ” ì‹ ë°œì´ ì¢‹ìŠµë‹ˆë‹¤');
            } else {
                recommendations.push('ì¼ë°˜ì ì¸ ëŸ¬ë‹í™”ë‚˜ ì›Œí‚¹í™”ê°€ ì í•©í•©ë‹ˆë‹¤');
                recommendations.push('ì ë‹¹í•œ ì¿ ì…”ë‹ê³¼ ì•ˆì •ì„±ì„ ì œê³µí•˜ëŠ” ì‹ ë°œì„ ì„ íƒí•˜ì„¸ìš”');
            }

            return recommendations;
        }

        // --- PDF ë‹¤ìš´ë¡œë“œ ë° ê³µìœ  ê¸°ëŠ¥ ---
        function downloadPDF() {
            if (!reportData) {
                alert('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('3D Foot Analysis Report', 20, 30);
                doc.setFontSize(12);
                doc.text(`File: ${reportData.fileName}`, 20, 50);
                doc.text(`Analysis Date: ${new Date(reportData.analysisDate).toLocaleDateString()}`, 20, 60);
                doc.setFontSize(16);
                doc.text('Measurements', 20, 80);
                doc.setFontSize(12);
                doc.text(`Length: ${reportData.measurements.length} ${reportData.measurements.unit}`, 20, 95);
                doc.text(`Width: ${reportData.measurements.width} ${reportData.measurements.unit}`, 20, 105);
                doc.text(`Height: ${reportData.measurements.height} ${reportData.measurements.unit}`, 20, 115);
                doc.setFontSize(16);
                doc.text('Ratios', 20, 135);
                doc.setFontSize(12);
                doc.text(`L/W Ratio: ${reportData.ratios.lengthWidth}`, 20, 150);
                doc.text(`H/L Ratio: ${reportData.ratios.heightLength}`, 20, 160);
                doc.setFontSize(16);
                doc.text('Foot Analysis', 20, 180);
                doc.setFontSize(12);
                doc.text(`Foot Type: ${reportData.analysis.footType}`, 20, 195);
                doc.text(`Arch Type: ${reportData.analysis.archType}`, 20, 205);

                const fileName = `foot_analysis_${reportData.fileName.replace('.ply', '')}_mobile.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                alert('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: '3D ë°œ ë¶„ì„ ë¦¬í¬íŠ¸',
                    text: `${reportData?.fileName || 'ë°œ ë¶„ì„'} ê²°ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.`,
                    url: window.location.href
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('ë¦¬í¬íŠ¸ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }).catch(() => {
                    alert('ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                });
            }
        }
    </script>
</body>

</html>